{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<section class="section-content padding-y bg">
  <div class="container">
    <div class="card">
      <div class="row no-gutters">
        <aside class="col-md-6">
          <article class="gallery-wrap">
            <div class="img-big-wrap">
              <a href="#"><img src="{{ single_product.images.url }}"></a>
            </div>
          </article>
        </aside>
            
        <main class="col-md-6 border-left">
          <form method="POST" action="{% url 'add_cart' single_product.id %}">
            {% csrf_token %}
            <h2 class="mb-4">{{ single_product.product_name }}</h2>

            {% if single_product.product_type == 'simple' %}
              <p class="lead">This is a simple product — no variations to choose from.</p>
              <p class="mt-3 mb-2"><strong>Price:</strong> ₦{{ single_product.price }}</p>
              <button type="submit" class="btn btn-primary w-100 mt-2">Add to Cart</button>

            {% elif single_product.product_type == 'variation' or single_product.product_type == 'combination' %}
              {% for category in variation_categories %}
                <div class="mb-3">
                  <label for="{{ category|lower }}">Choose {{ category|capfirst }}:</label>
                  <select name="{{ category|lower }}"
                          class="form-control variation-dropdown"
                          required>
                    <option value="" disabled selected>Select {{ category|capfirst }}</option>
                    {% for v in variations %}
                      {% if v.variation_type == category %}
                        <option value="{{ v.variation_value }}">
                          {{ v.variation_value|capfirst }}
                        </option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}

              <p id="dynamic-price" class="mt-3 mb-2">Price: ₦—</p>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary w-100" id="add-button" disabled>Select options</button>
              </div>
            {% endif %}
          </form>
        </main>
      </div>
    </div>

    <br>

    <div class="row">
      <div class="col-md-9">
        <header class="section-heading">
          <h3>Customer Reviews</h3>
        </header>
        <article class="box mb-3">
          <div class="icontext w-100">
            <img src="{% static 'images/avatars/avatar1.jpg' %}" class="img-xs icon rounded-circle">
            <div class="text">
              <span class="date text-muted float-md-right">24.04.2020</span>
              <h6 class="mb-1">Mike John</h6>
            </div>
          </div>
          <div class="mt-3">
            <p>
              Dummy comment Lorem ipsum dolor sit amet, consectetur adipisicing elit,
              sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </p>
          </div>
        </article>
      </div>
    </div>
  </div>
</section>

<script>
  function getSelectedVariations() {
    const selects = document.querySelectorAll('.variation-dropdown');
    const params = [];

    selects.forEach(select => {
      const category = select.name;
      const value = select.value;
      if (value) {
        params.push(`${category}=${encodeURIComponent(value)}`);
      }
    });

    return params.join('&');
  }

  function updateComboDisplay() {
    const query = getSelectedVariations();
    const productId = {{ single_product.id }};
    const priceDisplay = document.getElementById('dynamic-price');
    const addButton = document.getElementById('add-button');

    if (!query) {
      priceDisplay.textContent = 'Price: ₦—';
      addButton.disabled = true;
      addButton.textContent = 'Select options';
      return;
    }

    fetch(`/store/combo-info/?product_id=${productId}&${query}`)
      .then(res => res.json())
      .then(data => {
        priceDisplay.textContent = data.price
          ? `Price: ₦${data.price}`
          : 'Price: Not available';

        addButton.disabled = data.stock === 0;
        addButton.textContent = data.stock === 0 ? 'Out of stock' : 'Add to Cart';
      });
  }

  document.querySelectorAll('.variation-dropdown').forEach(select => {
    select.addEventListener('change', updateComboDisplay);
  });
</script>
{% endblock %}


